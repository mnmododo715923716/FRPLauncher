"""
ä¸»ç•Œé¢ - æ˜¾ç¤ºå’Œç®¡ç†ç«¯å£æ˜ å°„
"""

from PyQt5.QtWidgets import (
    QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QPushButton, QTableWidget, QTableWidgetItem,
    QHeaderView, QMessageBox, QInputDialog, QMenu,
    QAction, QSystemTrayIcon, QApplication, QToolBar,
    QStatusBar, QProgressBar, QSplitter, QScrollArea
)
from PyQt5.QtCore import (
    Qt, QTimer, pyqtSignal, QSize, QPoint, QSettings
)
from PyQt5.QtGui import (
    QFont, QIcon, QColor, QBrush, QPainter, QPen,
    QPixmap, QCursor
)

from config_manager import ConfigManager
from port_scanner import PortScanner, PortInfo
from frpc_controller import FrpcController, ProxyStatus
import traceback

class PortItemWidget(QWidget):
    """ç«¯å£é¡¹è‡ªå®šä¹‰éƒ¨ä»¶"""

    clicked = pyqtSignal(int)  # ç«¯å£å·

    def __init__(self, port_info: PortInfo, is_mapped: bool = False,
                 frpc_available: bool = True, status_text: str = ""):
        super().__init__()
        self.port_info = port_info
        self.is_mapped = is_mapped
        self.frpc_available = frpc_available
        self.status_text = status_text
        self.is_hovered = False
        self.setup_ui()
        self.setMouseTracking(True)
        self.setFixedHeight(70)  # å›ºå®šé«˜åº¦ï¼Œä¿æŒç»Ÿä¸€

    def setup_ui(self):
        """è®¾ç½®UI"""
        layout = QHBoxLayout()
        layout.setContentsMargins(15, 10, 15, 10)
        layout.setSpacing(10)

        # å·¦ä¾§ï¼šç«¯å£ä¿¡æ¯
        left_widget = QWidget()
        left_layout = QVBoxLayout(left_widget)
        left_layout.setContentsMargins(0, 0, 0, 0)

        # ç«¯å£å·å’Œè¿›ç¨‹å
        port_text = f"ç«¯å£: {self.port_info.port}"
        if self.port_info.process_name:
            port_text += f" ({self.port_info.process_name})"

        port_label = QLabel(port_text)
        port_label.setFont(QFont("å¾®è½¯é›…é»‘", 11, QFont.Bold))
        port_label.setStyleSheet("color: #ffffff;")

        # åè®®å’ŒPID
        detail_text = f"åè®®: {self.port_info.protocol.upper()}"
        if self.port_info.pid:
            detail_text += f" | PID: {self.port_info.pid}"
        detail_text += f" | åœ°å€: {self.port_info.local_addr}"

        detail_label = QLabel(detail_text)
        detail_label.setFont(QFont("å¾®è½¯é›…é»‘", 9))
        detail_label.setStyleSheet("color: #aaaaaa;")

        left_layout.addWidget(port_label)
        left_layout.addWidget(detail_label)

        # å³ä¾§ï¼šçŠ¶æ€å’Œæ“ä½œ
        right_widget = QWidget()
        right_layout = QVBoxLayout(right_widget)
        right_layout.setContentsMargins(0, 0, 0, 0)
        right_layout.setAlignment(Qt.AlignRight)

        # çŠ¶æ€æ ‡ç­¾
        if not self.frpc_available:
            status_text = "frpcä¸å¯ç”¨ âŒ"
            status_color = "#f44336"
            tip_text = "è¯·å®‰è£… frpc"
        elif self.is_mapped:
            status_text = self.status_text if self.status_text else "å·²æ˜ å°„ ğŸ”—"
            status_color = "#4CAF50"
            tip_text = "ç‚¹å‡»å…³é—­æ˜ å°„"
        else:
            status_text = "å¯æ˜ å°„ â¡"
            status_color = "#2196F3"
            tip_text = "ç‚¹å‡»å¼€å¯æ˜ å°„"

        status_label = QLabel(status_text)
        status_label.setFont(QFont("å¾®è½¯é›…é»‘", 10, QFont.Bold))
        status_label.setStyleSheet(f"color: {status_color};")
        status_label.setAlignment(Qt.AlignRight)

        tip_label = QLabel(tip_text)
        tip_label.setFont(QFont("å¾®è½¯é›…é»‘", 8))
        tip_label.setStyleSheet("color: #888;")
        tip_label.setAlignment(Qt.AlignRight)

        right_layout.addWidget(status_label)
        right_layout.addWidget(tip_label)

        # æ·»åŠ åˆ°ä¸»å¸ƒå±€
        layout.addWidget(left_widget, 1)  # å·¦ä¾§å æ®å‰©ä½™ç©ºé—´
        layout.addWidget(right_widget, 0, Qt.AlignRight)  # å³ä¾§å›ºå®šå®½åº¦

        self.setLayout(layout)
        self.update_style()

    def update_style(self):
        """æ›´æ–°æ ·å¼"""
        if not self.frpc_available:
            bg_color = "#5a2727"  # æ·±çº¢è‰²
            border_color = "#f44336"
        elif self.is_mapped:
            bg_color = "#2d5a27"  # æ·±ç»¿è‰²
            border_color = "#4CAF50"
        else:
            bg_color = "#1e3a5f"  # æ·±è“è‰²
            border_color = "#2196F3"

        if self.is_hovered and self.frpc_available:  # frpcä¸å¯ç”¨æ—¶ç¦ç”¨æ‚¬åœæ•ˆæœ
            bg_color = self._lighten_color(bg_color, 20)

        style = f"""
            background-color: {bg_color};
            border: 2px solid {border_color};
            border-radius: 8px;
            padding: 2px;
        """
        self.setStyleSheet(style)

    def _lighten_color(self, hex_color: str, amount: int) -> str:
        """è°ƒäº®é¢œè‰²"""
        hex_color = hex_color.lstrip('#')
        rgb = tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
        lightened = tuple(min(255, c + amount) for c in rgb)
        return f"#{lightened[0]:02x}{lightened[1]:02x}{lightened[2]:02x}"

    def mousePressEvent(self, event):
        """é¼ æ ‡ç‚¹å‡»äº‹ä»¶"""
        if event.button() == Qt.LeftButton and self.frpc_available:
            self.clicked.emit(self.port_info.port)
        elif event.button() == Qt.LeftButton and not self.frpc_available:
            # frpcä¸å¯ç”¨æ—¶æ˜¾ç¤ºæç¤º
            from PyQt5.QtWidgets import QToolTip
            QToolTip.showText(
                event.globalPos(),
                "frpcä¸å¯ç”¨ï¼Œè¯·å®‰è£… frpc å¹¶æ·»åŠ åˆ° PATH",
                self
            )

    def enterEvent(self, event):
        """é¼ æ ‡è¿›å…¥äº‹ä»¶"""
        if self.frpc_available:  # åªæœ‰frpcå¯ç”¨æ—¶æ‰å¯ç”¨æ‚¬åœæ•ˆæœ
            self.is_hovered = True
            self.update_style()
            self.setCursor(Qt.PointingHandCursor)

    def leaveEvent(self, event):
        """é¼ æ ‡ç¦»å¼€äº‹ä»¶"""
        if self.frpc_available:
            self.is_hovered = False
            self.update_style()
            self.setCursor(Qt.ArrowCursor)

    def set_mapped(self, mapped: bool, status_text: str = ""):
        """è®¾ç½®æ˜ å°„çŠ¶æ€"""
        self.is_mapped = mapped
        if status_text:
            self.status_text = status_text
        self.update_style()

class MainWindow(QMainWindow):
    """ä¸»çª—å£ç±»"""

    def __init__(self, config_manager: ConfigManager):
        super().__init__()
        self.config_manager = config_manager

        # è·å–é…ç½®ä¸­çš„æ‰«æé—´éš”
        scan_interval = self.config_manager.get_scan_interval()
        ui_refresh_interval = self.config_manager.get_ui_refresh_interval()

        print(f"ä½¿ç”¨æ‰«æé—´éš”: {scan_interval}ç§’")
        print(f"ä½¿ç”¨UIåˆ·æ–°é—´éš”: {ui_refresh_interval}ç§’")

        # åˆ›å»ºç«¯å£æ‰«æå™¨ï¼ˆä½¿ç”¨é…ç½®çš„æ‰«æé—´éš”ï¼‰
        self.port_scanner = PortScanner(update_interval=scan_interval)
        self.frpc_controller = FrpcController(
            config_manager.get_frpc_config_path()
        )

        self.port_widgets = {}  # ç«¯å£å· -> éƒ¨ä»¶æ˜ å°„
        self._is_real_close = False  # æ ‡è®°æ˜¯å¦ä¸ºçœŸæ­£å…³é—­

        # æ£€æŸ¥ frpc å¯ç”¨æ€§
        self.frpc_available = self.frpc_controller.is_frpc_available()
        if not self.frpc_available:
            print("è­¦å‘Š: frpc ä¸å¯ç”¨ï¼Œç«¯å£æ˜ å°„åŠŸèƒ½å°†å—é™")

        # æ·»åŠ è°ƒè¯•ä¿¡æ¯è¾“å‡º
        print(f"ä¸»çª—å£åˆå§‹åŒ–å®Œæˆ")
        print(f"é…ç½®æ–‡ä»¶: {config_manager.get_frpc_config_path()}")
        print(f"frpc å¯ç”¨: {self.frpc_available}")

        self.setup_ui()
        self.setup_connections()
        self.start_services()

    def setup_ui(self):
        """è®¾ç½®UI"""
        self.setWindowTitle("æ™ºèƒ½ç«¯å£æ˜ å°„æ§åˆ¶å™¨")
        self.setGeometry(100, 100, 800, 600)

        # åˆ›å»ºä¸­å¿ƒéƒ¨ä»¶
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        main_layout = QVBoxLayout(central_widget)

        # æ ‡é¢˜æ 
        title_layout = QHBoxLayout()

        title_label = QLabel("ğŸ”„ æ™ºèƒ½ç«¯å£æ˜ å°„")
        title_label.setFont(QFont("å¾®è½¯é›…é»‘", 16, QFont.Bold))
        title_label.setStyleSheet("color: #ffffff;")

        # çŠ¶æ€æ ‡ç­¾ï¼Œæ˜¾ç¤º frpc å¯ç”¨æ€§å’Œæ‰«æé—´éš”
        scan_interval = self.config_manager.get_scan_interval()
        if self.frpc_available:
            status_text = f"frpc å¯ç”¨ | æ‰«æé—´éš”: {scan_interval}ç§’"
            status_color = "#4CAF50"
        else:
            status_text = f"frpc ä¸å¯ç”¨ | æ‰«æé—´éš”: {scan_interval}ç§’"
            status_color = "#f44336"

        self.status_label = QLabel(status_text)
        self.status_label.setFont(QFont("å¾®è½¯é›…é»‘", 10))
        self.status_label.setStyleSheet(f"color: {status_color};")

        title_layout.addWidget(title_label)
        title_layout.addStretch()
        title_layout.addWidget(self.status_label)

        # ç«¯å£åˆ—è¡¨å®¹å™¨
        self.ports_container = QWidget()
        self.ports_layout = QVBoxLayout(self.ports_container)
        self.ports_layout.setSpacing(10)
        self.ports_layout.addStretch()

        # æ»šåŠ¨åŒºåŸŸ
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setWidget(self.ports_container)
        scroll_area.setStyleSheet("""
            QScrollArea {
                border: none;
                background-color: transparent;
            }
            QScrollBar:vertical {
                background-color: #2d2d2d;
                width: 12px;
                border-radius: 6px;
            }
            QScrollBar::handle:vertical {
                background-color: #4a4a4a;
                border-radius: 6px;
                min-height: 30px;
            }
        """)

        # æ§åˆ¶æŒ‰é’®
        control_layout = QHBoxLayout()

        self.refresh_btn = QPushButton("ğŸ”„ åˆ·æ–°ç«¯å£")
        self.settings_btn = QPushButton("âš™ï¸ è®¾ç½®")
        self.app_settings_btn = QPushButton("ğŸ“Š åº”ç”¨è®¾ç½®")  # æ–°å¢åº”ç”¨è®¾ç½®æŒ‰é’®
        self.quit_btn = QPushButton("âŒ é€€å‡º")

        for btn in [self.refresh_btn, self.settings_btn, self.app_settings_btn, self.quit_btn]:
            btn.setMinimumHeight(40)
            btn.setFont(QFont("å¾®è½¯é›…é»‘", 10))

        control_layout.addWidget(self.refresh_btn)
        control_layout.addWidget(self.settings_btn)
        control_layout.addWidget(self.app_settings_btn)
        control_layout.addStretch()
        control_layout.addWidget(self.quit_btn)

        # æ·»åŠ åˆ°ä¸»å¸ƒå±€
        main_layout.addLayout(title_layout)
        main_layout.addWidget(scroll_area, 1)
        main_layout.addLayout(control_layout)

        # è®¾ç½®æ ·å¼
        self.setStyleSheet("""
            QMainWindow {
                background-color: #1e1e1e;
            }
            QPushButton {
                background-color: #2d2d2d;
                color: white;
                border: 2px solid #3d3d3d;
                border-radius: 6px;
                padding: 8px 16px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #3d3d3d;
                border-color: #4d4d4d;
            }
            QPushButton:pressed {
                background-color: #2a2a2a;
            }
        """)

    def setup_connections(self):
        """è®¾ç½®ä¿¡å·è¿æ¥"""
        # æŒ‰é’®è¿æ¥
        self.refresh_btn.clicked.connect(self.refresh_ports)
        self.settings_btn.clicked.connect(self.show_settings)
        self.app_settings_btn.clicked.connect(self.show_app_settings)  # è¿æ¥åº”ç”¨è®¾ç½®
        self.quit_btn.clicked.connect(self.real_close)

        # ç«¯å£æ‰«æå™¨ä¿¡å·è¿æ¥
        self.port_scanner.ports_updated.connect(self.on_ports_updated)

        # å®šæ—¶åˆ·æ–° - ä½¿ç”¨é…ç½®ä¸­çš„UIåˆ·æ–°é—´éš”
        self.refresh_timer = QTimer()
        self.refresh_timer.timeout.connect(self.refresh_ports)

        # è½¬æ¢ä¸ºæ¯«ç§’
        refresh_interval_ms = self.config_manager.get_ui_refresh_interval() * 1000
        self.refresh_timer.start(refresh_interval_ms)

        print(f"UIåˆ·æ–°å®šæ—¶å™¨å¯åŠ¨ï¼Œé—´éš”: {refresh_interval_ms}æ¯«ç§’")

    def start_services(self):
        """å¯åŠ¨æœåŠ¡"""
        # å¯åŠ¨ç«¯å£æ‰«æï¼ˆå¦‚æœæœªå¯åŠ¨ï¼‰
        if not self.port_scanner._running:
            self.port_scanner.start()
            print(f"ç«¯å£æ‰«æå™¨å·²å¯åŠ¨ï¼Œæ‰«æé—´éš”: {self.config_manager.get_scan_interval()}ç§’")

        # åˆå§‹åˆ·æ–°
        self.refresh_ports()

    def refresh_ports(self):
        """åˆ·æ–°ç«¯å£åˆ—è¡¨"""
        try:
            # å¦‚æœç«¯å£æ‰«æå™¨å·²åœæ­¢ï¼Œé‡æ–°å¯åŠ¨
            if not self.port_scanner._running:
                print("ç«¯å£æ‰«æå™¨å·²åœæ­¢ï¼Œé‡æ–°å¯åŠ¨...")
                self.port_scanner.start()

            # è·å–ç›‘å¬ç«¯å£
            ports = self.port_scanner.get_listening_ports()

            # è·å–æ´»è·ƒï¼ˆè¿è¡Œä¸­ï¼‰çš„ä»£ç†
            active_proxies = self.frpc_controller.get_active_proxies()

            # è·å–æ‰€æœ‰ä»£ç†ï¼ˆåŒ…æ‹¬éæ´»è·ƒçš„ï¼‰
            all_proxies = self.frpc_controller.get_all_proxies()

            # åˆ›å»ºç«¯å£åˆ°ä»£ç†çš„æ˜ å°„
            port_to_proxy = {}
            for proxy in all_proxies:
                port_to_proxy[proxy.local_port] = proxy

            # æ¸…ç©ºç°æœ‰éƒ¨ä»¶ï¼ˆé™¤äº†å ä½çš„stretchï¼‰
            while self.ports_layout.count() > 1:  # ä¿ç•™æœ€åçš„stretch
                item = self.ports_layout.itemAt(0)
                if item.widget():
                    item.widget().deleteLater()
                self.ports_layout.removeItem(item)

            self.port_widgets.clear()

            # æŒ‰ç«¯å£å·æ’åº
            ports.sort(key=lambda x: x.port)

            # åˆ›å»ºå¹¶æ·»åŠ ç«¯å£éƒ¨ä»¶
            for port_info in ports:
                port = port_info.port

                # æ£€æŸ¥ç«¯å£æ˜¯å¦æœ‰å¯¹åº”çš„ä»£ç†
                proxy = port_to_proxy.get(port)

                if proxy:
                    # ç«¯å£æœ‰ä»£ç†
                    is_mapped = proxy.is_active
                    status_text = proxy.status.value
                else:
                    # ç«¯å£æ— ä»£ç†
                    is_mapped = False
                    status_text = ""

                # åˆ›å»ºç«¯å£éƒ¨ä»¶
                widget = PortItemWidget(
                    port_info,
                    is_mapped=is_mapped,
                    frpc_available=self.frpc_available,
                    status_text=status_text
                )
                widget.clicked.connect(self.on_port_clicked)

                # æ·»åŠ åˆ°å¸ƒå±€
                self.ports_layout.insertWidget(
                    self.ports_layout.count() - 1,  # æ’å…¥åˆ°stretchä¹‹å‰
                    widget
                )

                # ä¿å­˜åˆ°å­—å…¸
                self.port_widgets[port] = widget

            # æ›´æ–°çŠ¶æ€æ ‡ç­¾
            active_count = len(active_proxies)
            total_count = len(ports)
            scan_interval = self.config_manager.get_scan_interval()

            if self.frpc_available:
                status_text = f"frpc å¯ç”¨ | ç«¯å£: {total_count} | æ´»è·ƒæ˜ å°„: {active_count} | æ‰«æé—´éš”: {scan_interval}ç§’"
                status_color = "#4CAF50"
            else:
                status_text = f"frpc ä¸å¯ç”¨ | ç«¯å£: {total_count} | æ‰«æé—´éš”: {scan_interval}ç§’"
                status_color = "#f44336"

            self.status_label.setText(status_text)
            self.status_label.setStyleSheet(f"color: {status_color};")

            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç«¯å£ï¼Œæ˜¾ç¤ºæç¤º
            if total_count == 0:
                no_ports_label = QLabel("æœªæ£€æµ‹åˆ°ä»»ä½•ç›‘å¬ç«¯å£")
                no_ports_label.setAlignment(Qt.AlignCenter)
                no_ports_label.setStyleSheet("color: #888; font-size: 12px;")
                self.ports_layout.insertWidget(0, no_ports_label)

        except Exception as e:
            print(f"åˆ·æ–°ç«¯å£å¤±è´¥: {e}")
            traceback.print_exc()

    def on_ports_updated(self, added, removed, changed):
        """ç«¯å£æ›´æ–°å›è°ƒ - é€šè¿‡ä¿¡å·è§¦å‘"""
        # è¿™æ˜¯é€šè¿‡ä¿¡å·è°ƒç”¨çš„ï¼Œå·²ç»åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå¯ä»¥ç›´æ¥åˆ·æ–°
        self.refresh_ports()

    def on_port_clicked(self, port: int):
        """ç«¯å£ç‚¹å‡»äº‹ä»¶"""
        # æ£€æŸ¥ frpc æ˜¯å¦å¯ç”¨
        if not self.frpc_available:
            QMessageBox.warning(
                self,
                "frpc ä¸å¯ç”¨",
                "frpc ä¸å¯ç”¨ï¼Œæ— æ³•è¿›è¡Œç«¯å£æ˜ å°„ã€‚\n"
                "è¯·ç¡®ä¿ frpc å·²å®‰è£…å¹¶æ·»åŠ åˆ°ç³»ç»Ÿ PATH ä¸­ã€‚\n\n"
                "ä¸‹è½½åœ°å€: https://github.com/fatedier/frp/releases"
            )
            return

        # æ ¹æ®æœ¬åœ°ç«¯å£æŸ¥æ‰¾ä»£ç†ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨å›ºå®šåç§°ï¼‰
        proxy = self.frpc_controller.get_proxy_by_local_port(port)

        if proxy and proxy.is_active:
            # å·²æ˜ å°„ä¸”æ´»è·ƒï¼Œç‚¹å‡»å…³é—­
            reply = QMessageBox.question(
                self, "ç¡®è®¤å…³é—­",
                f"ç¡®å®šè¦å…³é—­ç«¯å£ {port} çš„æ˜ å°„å—ï¼Ÿ\n"
                f"å½“å‰æ˜ å°„: {proxy.local_port} -> {proxy.remote_port}",
                QMessageBox.Yes | QMessageBox.No
            )

            if reply == QMessageBox.Yes:
                success = self.frpc_controller.remove_proxy(proxy.name)
                if success:
                    QMessageBox.information(
                        self, "æˆåŠŸ",
                        f"å·²å…³é—­ç«¯å£æ˜ å°„: {proxy.local_port} -> {proxy.remote_port}"
                    )
                    self.refresh_ports()
                else:
                    QMessageBox.warning(self, "å¤±è´¥", "å…³é—­æ˜ å°„å¤±è´¥")
        elif proxy and not proxy.is_active:
            # æœ‰ä»£ç†ä½†æœªæ¿€æ´»ï¼Œè¯¢é—®æ˜¯å¦æ¿€æ´»
            reply = QMessageBox.question(
                self, "ä»£ç†æœªæ¿€æ´»",
                f"ç«¯å£ {port} çš„ä»£ç†å·²å­˜åœ¨ä½†æœªæ¿€æ´»ã€‚\n"
                f"æ˜¯å¦è¦æ¿€æ´»æ˜ å°„: {proxy.local_port} -> {proxy.remote_port}ï¼Ÿ",
                QMessageBox.Yes | QMessageBox.No
            )

            if reply == QMessageBox.Yes:
                start_success, start_message = self.frpc_controller.start_proxy(proxy.name)
                if start_success:
                    QMessageBox.information(self, "æˆåŠŸ", start_message)
                    self.refresh_ports()
                else:
                    QMessageBox.warning(self, "å¤±è´¥", start_message)
        else:
            # æœªæ˜ å°„ï¼Œç‚¹å‡»æ‰“å¼€
            remote_port, ok = QInputDialog.getInt(
                self, "è¿œç¨‹ç«¯å£",
                f"è¯·è¾“å…¥ç«¯å£ {port} çš„è¿œç¨‹æ˜ å°„ç«¯å£:",
                value=port, min=1, max=65535
            )

            if ok:
                # æ·»åŠ ä»£ç†
                success, message = self.frpc_controller.add_proxy(port, remote_port)

                if success:
                    # æ·»åŠ æˆåŠŸåå†æ¬¡æŸ¥æ‰¾ä»£ç†
                    proxy = self.frpc_controller.get_proxy_by_local_port(port)
                    if proxy:
                        # æ ¹æ®é…ç½®å†³å®šæ˜¯å¦è‡ªåŠ¨å¯åŠ¨ä»£ç†
                        if self.config_manager.app_config.auto_start_proxy:
                            # å¯åŠ¨ä»£ç†
                            start_success, start_message = self.frpc_controller.start_proxy(proxy.name)

                            if start_success:
                                QMessageBox.information(
                                    self, "æˆåŠŸ",
                                    f"å·²å¼€å¯ç«¯å£æ˜ å°„: {proxy.local_port} -> {proxy.remote_port}"
                                )
                                self.refresh_ports()
                            else:
                                QMessageBox.warning(self, "å¤±è´¥", start_message)
                                # å¯åŠ¨å¤±è´¥ï¼Œç§»é™¤ä»£ç†
                                self.frpc_controller.remove_proxy(proxy.name)
                        else:
                            # ä¸è‡ªåŠ¨å¯åŠ¨ï¼Œåªåˆ›å»ºé…ç½®
                            QMessageBox.information(
                                self, "æˆåŠŸ",
                                f"å·²åˆ›å»ºä»£ç†é…ç½®ï¼Œä½†æœªè‡ªåŠ¨å¯åŠ¨ã€‚\n"
                                f"æ˜ å°„: {proxy.local_port} -> {proxy.remote_port}"
                            )
                            self.refresh_ports()
                    else:
                        QMessageBox.warning(self, "å¤±è´¥", "æ·»åŠ ä»£ç†åæœªæ‰¾åˆ°ä»£ç†é…ç½®")
                else:
                    QMessageBox.warning(self, "å¤±è´¥", message)

    def show_settings(self):
        """æ˜¾ç¤ºæœåŠ¡å™¨è®¾ç½®"""
        from setup_wizard import SetupWizard
        wizard = SetupWizard(self.config_manager)
        if wizard.exec_and_setup():
            # é…ç½®å·²æ›´æ–°ï¼Œé‡æ–°åˆå§‹åŒ–FRPæ§åˆ¶å™¨
            self.frpc_controller = FrpcController(
                self.config_manager.get_frpc_config_path()
            )
            self.frpc_available = self.frpc_controller.is_frpc_available()
            QMessageBox.information(self, "æˆåŠŸ", "æœåŠ¡å™¨è®¾ç½®å·²æ›´æ–°")

    def show_app_settings(self):
        """æ˜¾ç¤ºåº”ç”¨ç¨‹åºè®¾ç½®"""
        from PyQt5.QtWidgets import (
            QDialog, QVBoxLayout, QHBoxLayout, QFormLayout,
            QLabel, QSpinBox, QCheckBox, QPushButton,
            QGroupBox
        )

        dialog = QDialog(self)
        dialog.setWindowTitle("åº”ç”¨ç¨‹åºè®¾ç½®")
        dialog.setGeometry(200, 200, 400, 300)

        layout = QVBoxLayout()

        # æ‰«æè®¾ç½®ç»„
        scan_group = QGroupBox("æ‰«æè®¾ç½®")
        scan_layout = QFormLayout()

        # ç«¯å£æ‰«æé—´éš”
        self.scan_interval_spin = QSpinBox()
        self.scan_interval_spin.setRange(5, 300)  # 5ç§’åˆ°5åˆ†é’Ÿ
        self.scan_interval_spin.setValue(self.config_manager.get_scan_interval())
        self.scan_interval_spin.setSuffix(" ç§’")
        scan_layout.addRow("ç«¯å£æ‰«æé—´éš”:", self.scan_interval_spin)

        # UIåˆ·æ–°é—´éš”
        self.ui_refresh_spin = QSpinBox()
        self.ui_refresh_spin.setRange(2, 60)  # 2ç§’åˆ°1åˆ†é’Ÿ
        self.ui_refresh_spin.setValue(self.config_manager.get_ui_refresh_interval())
        self.ui_refresh_spin.setSuffix(" ç§’")
        scan_layout.addRow("UIåˆ·æ–°é—´éš”:", self.ui_refresh_spin)

        scan_group.setLayout(scan_layout)
        layout.addWidget(scan_group)

        # è¡Œä¸ºè®¾ç½®ç»„
        behavior_group = QGroupBox("è¡Œä¸ºè®¾ç½®")
        behavior_layout = QVBoxLayout()

        # è‡ªåŠ¨å¯åŠ¨ä»£ç†
        self.auto_start_check = QCheckBox("æ·»åŠ ä»£ç†åè‡ªåŠ¨å¯åŠ¨")
        self.auto_start_check.setChecked(self.config_manager.app_config.auto_start_proxy)
        behavior_layout.addWidget(self.auto_start_check)

        # æœ€å°åŒ–åˆ°æ‰˜ç›˜
        self.minimize_check = QCheckBox("å…³é—­çª—å£æ—¶æœ€å°åŒ–åˆ°æ‰˜ç›˜")
        self.minimize_check.setChecked(self.config_manager.app_config.minimize_to_tray)
        behavior_layout.addWidget(self.minimize_check)

        # æ˜¾ç¤ºç³»ç»Ÿç«¯å£
        self.system_ports_check = QCheckBox("æ˜¾ç¤ºç³»ç»Ÿç«¯å£ (<1024)")
        self.system_ports_check.setChecked(self.config_manager.app_config.show_system_ports)
        behavior_layout.addWidget(self.system_ports_check)

        behavior_group.setLayout(behavior_layout)
        layout.addWidget(behavior_group)

        # æŒ‰é’®
        button_layout = QHBoxLayout()

        save_btn = QPushButton("ä¿å­˜")
        save_btn.clicked.connect(lambda: self.save_app_settings(dialog))

        cancel_btn = QPushButton("å–æ¶ˆ")
        cancel_btn.clicked.connect(dialog.reject)

        button_layout.addStretch()
        button_layout.addWidget(save_btn)
        button_layout.addWidget(cancel_btn)

        layout.addLayout(button_layout)

        dialog.setLayout(layout)
        dialog.exec_()

    def save_app_settings(self, dialog):
        """ä¿å­˜åº”ç”¨ç¨‹åºè®¾ç½®"""
        try:
            # ä¿å­˜æ‰«æè®¾ç½®
            self.config_manager.set_scan_interval(self.scan_interval_spin.value())
            self.config_manager.set_ui_refresh_interval(self.ui_refresh_spin.value())

            # ä¿å­˜è¡Œä¸ºè®¾ç½®
            self.config_manager.app_config.auto_start_proxy = self.auto_start_check.isChecked()
            self.config_manager.app_config.minimize_to_tray = self.minimize_check.isChecked()
            self.config_manager.app_config.show_system_ports = self.system_ports_check.isChecked()

            # ä¿å­˜é…ç½®
            if self.config_manager.save():
                # æ›´æ–°ç«¯å£æ‰«æå™¨çš„æ‰«æé—´éš”
                scan_interval = self.config_manager.get_scan_interval()
                self.port_scanner.update_interval = scan_interval
                print(f"ç«¯å£æ‰«æé—´éš”å·²æ›´æ–°ä¸º: {scan_interval}ç§’")

                # æ›´æ–°UIåˆ·æ–°å®šæ—¶å™¨
                refresh_interval_ms = self.config_manager.get_ui_refresh_interval() * 1000
                self.refresh_timer.stop()
                self.refresh_timer.start(refresh_interval_ms)
                print(f"UIåˆ·æ–°é—´éš”å·²æ›´æ–°ä¸º: {refresh_interval_ms}æ¯«ç§’")

                # åˆ·æ–°çŠ¶æ€æ ‡ç­¾
                self.refresh_ports()

                QMessageBox.information(dialog, "æˆåŠŸ", "åº”ç”¨ç¨‹åºè®¾ç½®å·²ä¿å­˜")
                dialog.accept()
            else:
                QMessageBox.warning(dialog, "é”™è¯¯", "ä¿å­˜è®¾ç½®å¤±è´¥")
        except Exception as e:
            QMessageBox.critical(dialog, "é”™è¯¯", f"ä¿å­˜è®¾ç½®æ—¶å‡ºé”™: {str(e)}")

    def real_close(self):
        """çœŸæ­£çš„å…³é—­ç¨‹åº"""
        self._is_real_close = True
        self.close()

    def closeEvent(self, event):
        """å…³é—­äº‹ä»¶"""
        # æ ¹æ®é…ç½®å†³å®šæ˜¯å¦æœ€å°åŒ–åˆ°æ‰˜ç›˜
        if self.config_manager.app_config.minimize_to_tray and not self._is_real_close:
            # æœ€å°åŒ–åˆ°æ‰˜ç›˜
            print("æœ€å°åŒ–åˆ°æ‰˜ç›˜...")
            self.hide()
            event.ignore()
        else:
            # çœŸæ­£é€€å‡ºç¨‹åº
            print("æ­£åœ¨åœæ­¢æœåŠ¡å¹¶é€€å‡ºç¨‹åº...")

            # åœæ­¢å®šæ—¶å™¨
            if self.refresh_timer:
                self.refresh_timer.stop()

            # åœæ­¢ç«¯å£æ‰«æ
            self.port_scanner.stop()

            # åœæ­¢FRPæ§åˆ¶å™¨
            self.frpc_controller.stop_all()

            # ä¿å­˜é…ç½®
            self.config_manager.save()

            # é€€å‡ºåº”ç”¨ç¨‹åº
            QApplication.quit()

    def showEvent(self, event):
        """çª—å£æ˜¾ç¤ºäº‹ä»¶"""
        super().showEvent(event)
        # çª—å£é‡æ–°æ˜¾ç¤ºæ—¶åˆ·æ–°ç«¯å£åˆ—è¡¨
        if self.isVisible():
            print("çª—å£é‡æ–°æ˜¾ç¤ºï¼Œåˆ·æ–°ç«¯å£åˆ—è¡¨...")
            self.refresh_ports()
